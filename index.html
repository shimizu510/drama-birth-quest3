<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DramaBirthQuest Web Uploader</title>
  <link rel="preconnect" href="https://cdn.apple-mapkit.com" crossorigin>
  <script src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js"></script>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Helvetica Neue", Arial, sans-serif;
      --accent: #6c4cff;
      --bg: #f5f5f7;
      --bg-dark: #1c1c1e;
      --card: rgba(255, 255, 255, 0.85);
      --card-dark: rgba(28, 28, 30, 0.85);
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, rgba(108, 76, 255, 0.2), rgba(0, 199, 190, 0.2)), var(--bg);
      color: #1f1f1f;
      display: flex;
      flex-direction: column;
    }

    body.dark {
      background: linear-gradient(135deg, rgba(108, 76, 255, 0.35), rgba(0, 199, 190, 0.35)), var(--bg-dark);
      color: #f5f5f7;
    }

    header {
      padding: 2rem clamp(1rem, 4vw, 3rem) 1.5rem;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: clamp(2rem, 5vw, 3.5rem);
      font-weight: 700;
      color: var(--accent);
    }

    header p {
      margin-top: 0.75rem;
      font-size: clamp(1rem, 2.5vw, 1.25rem);
      line-height: 1.6;
    }

    main {
      flex: 1 1 auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: clamp(1.5rem, 3vw, 2.5rem);
      padding: 0 clamp(1rem, 4vw, 3rem) 3rem;
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.12);
      backdrop-filter: blur(10px);
      padding: clamp(1.25rem, 3vw, 2rem);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    body.dark .card {
      background: var(--card-dark);
    }

    h2 {
      margin: 0;
      font-size: 1.25rem;
      color: var(--accent);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    label {
      font-size: 0.95rem;
      font-weight: 600;
      display: block;
      margin-bottom: 0.4rem;
    }

    input[type="text"],
    input[type="number"],
    input[type="url"],
    textarea,
    select {
      width: 100%;
      padding: 0.65rem 0.75rem;
      border-radius: 12px;
      border: 1px solid rgba(31, 31, 31, 0.15);
      background: rgba(255, 255, 255, 0.9);
      font-size: 0.95rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    body.dark input,
    body.dark textarea,
    body.dark select {
      background: rgba(44, 44, 46, 0.8);
      border-color: rgba(245, 245, 247, 0.2);
      color: inherit;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(108, 76, 255, 0.2);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .map-wrapper {
      border-radius: 14px;
      overflow: hidden;
      height: 320px;
      position: relative;
      background: rgba(0, 0, 0, 0.05);
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.75rem 1.5rem;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }

    button.primary {
      background: linear-gradient(135deg, #6c4cff, #00c7be);
      color: white;
      box-shadow: 0 14px 30px rgba(108, 76, 255, 0.35);
    }

    button.secondary {
      background: rgba(108, 76, 255, 0.1);
      color: var(--accent);
    }

    button.danger {
      background: rgba(255, 99, 132, 0.12);
      color: #ff496a;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
    }

    .flex-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .flex-row .field {
      flex: 1 1 160px;
    }

    pre#quest-preview {
      background: rgba(0, 0, 0, 0.75);
      color: #f5f5f5;
      border-radius: 12px;
      padding: 1rem;
      max-height: 280px;
      overflow: auto;
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .log {
      font-size: 0.85rem;
      line-height: 1.4;
      white-space: pre-wrap;
      min-height: 2.5rem;
    }

    footer {
      text-align: center;
      padding: 1.5rem;
      font-size: 0.85rem;
      color: rgba(31, 31, 31, 0.6);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        color-scheme: dark;
      }

      body:not(.light) {
        background: linear-gradient(135deg, rgba(108, 76, 255, 0.35), rgba(0, 199, 190, 0.35)), var(--bg-dark);
        color: #f5f5f7;
      }

      footer {
        color: rgba(245, 245, 247, 0.6);
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>DramaBirthQuest Web Uploader</h1>
    <p>3DAdventureのクエストをウェブ上で設計・生成し、MapKit上の位置とともにアップロードできます。<br>
      OpenAI Atlasで自動生成したシナリオをもとにチームメンバーと共有しましょう。</p>
  </header>

  <main>
    <section class="card" aria-labelledby="mapkit-setup">
      <h2 id="mapkit-setup">MapKit 設定</h2>
      <p>MapKit JSのJWTトークンを入力してマップを初期化してください。トークンを持っていない場合は、<a href="https://developer.apple.com/documentation/mapkitjs" target="_blank" rel="noopener">Apple Developer</a>で発行できます。</p>
      <label for="mapkit-token">MapKit JWT</label>
      <input id="mapkit-token" type="text" placeholder="eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9...">
      <div class="button-row">
        <button class="primary" type="button" id="mapkit-init">Mapを初期化</button>
        <button class="secondary" type="button" id="toggle-theme">ライト/ダーク切替</button>
      </div>
      <div class="map-wrapper" role="region" aria-label="クエスト設置用マップ">
        <div id="map"></div>
      </div>
      <div class="flex-row">
        <div class="field">
          <label for="latitude">緯度 (Latitude)</label>
          <input id="latitude" type="number" step="any" placeholder="35.6809591">
        </div>
        <div class="field">
          <label for="longitude">経度 (Longitude)</label>
          <input id="longitude" type="number" step="any" placeholder="139.7673068">
        </div>
        <div class="field">
          <label for="regionRadius">表示範囲 (m)</label>
          <input id="regionRadius" type="number" min="100" value="500">
        </div>
      </div>
      <p class="log" id="map-log">マップが未初期化です。JWTを入力して「Mapを初期化」を押してください。</p>
    </section>

    <section class="card" aria-labelledby="quest-settings">
      <h2 id="quest-settings">クエスト設定</h2>
      <label for="quest-title">タイトル</label>
      <input id="quest-title" type="text" placeholder="例: 失われた記憶のかけら">

      <label for="quest-summary">概要</label>
      <textarea id="quest-summary" placeholder="クエストの背景と目的を入力してください"></textarea>

      <label for="quest-objectives">目的 (箇条書き可)</label>
      <textarea id="quest-objectives" placeholder="1. ...
2. ..."></textarea>

      <label for="quest-difficulty">難易度</label>
      <select id="quest-difficulty">
        <option value="easy">Easy</option>
        <option value="normal" selected>Normal</option>
        <option value="hard">Hard</option>
        <option value="epic">Epic</option>
      </select>

      <label for="quest-rewards">報酬</label>
      <textarea id="quest-rewards" placeholder="経験値: 500
ゴールド: 200
アイテム: ..."></textarea>

      <label for="quest-triggers">トリガー条件</label>
      <textarea id="quest-triggers" placeholder="プレイヤーが◯◯に到着した時 ..."></textarea>

      <label for="quest-notes">共有メモ (任意)</label>
      <textarea id="quest-notes" placeholder="チームメモやQA注意点など"></textarea>
    </section>

    <section class="card" aria-labelledby="atlas-auto">
      <h2 id="atlas-auto">OpenAI Atlas 自動生成</h2>
      <p>Atlasにクエスト生成を依頼する場合はAPIキーを入力してください。緯度経度が設定されていると、その場所にちなんだストーリーが生成されます。</p>
      <label for="openai-api-key">OpenAI API Key</label>
      <input id="openai-api-key" type="text" placeholder="sk-...">

      <label for="atlas-directive">追加プロンプト (任意)</label>
      <textarea id="atlas-directive" placeholder="例: プレイヤーは音楽家。クエストは桜の季節の東京駅周辺で行う。"></textarea>

      <div class="button-row">
        <button class="primary" type="button" id="generate-quest">Atlasでクエストを生成</button>
        <button class="secondary" type="button" id="clear-form">入力をクリア</button>
      </div>

      <label for="quest-preview">生成/アップロード内容プレビュー</label>
      <pre id="quest-preview" aria-live="polite">{
  "title": "",
  "summary": "",
  "objectives": [],
  "location": {
    "latitude": null,
    "longitude": null,
    "radius": 500
  }
}</pre>
      <p class="log" id="atlas-log">Atlasのレスポンスやエラーがここに表示されます。</p>
    </section>

    <section class="card" aria-labelledby="upload-section">
      <h2 id="upload-section">アップロード &amp; エクスポート</h2>
      <label for="upload-endpoint">クエストAPIエンドポイント</label>
      <input id="upload-endpoint" type="url" placeholder="https://example.com/api/quests">

      <label for="upload-token">認証トークン (必要な場合)</label>
      <input id="upload-token" type="text" placeholder="Bearer ...">

      <div class="button-row">
        <button class="primary" type="button" id="upload-quest">アップロード</button>
        <button class="secondary" type="button" id="download-quest">JSONをダウンロード</button>
        <button class="danger" type="button" id="reset-all">すべてリセット</button>
      </div>

      <p class="log" id="upload-log">アップロード結果がここに表示されます。</p>
    </section>
  </main>

  <footer>
    3DAdventure Quest Builder &copy; 2025 — Swift版のロジックに合わせたJSONスキーマを採用しています。
  </footer>

  <script>
    const state = {
      map: null,
      marker: null,
      selectedCoordinate: null,
      atlasController: new AbortController()
    };

    const mapLog = document.getElementById('map-log');
    const atlasLog = document.getElementById('atlas-log');
    const uploadLog = document.getElementById('upload-log');
    const questPreview = document.getElementById('quest-preview');

    const latitudeInput = document.getElementById('latitude');
    const longitudeInput = document.getElementById('longitude');
    const radiusInput = document.getElementById('regionRadius');

    const questFields = {
      title: document.getElementById('quest-title'),
      summary: document.getElementById('quest-summary'),
      objectives: document.getElementById('quest-objectives'),
      difficulty: document.getElementById('quest-difficulty'),
      rewards: document.getElementById('quest-rewards'),
      triggers: document.getElementById('quest-triggers'),
      notes: document.getElementById('quest-notes')
    };

    document.getElementById('toggle-theme').addEventListener('click', () => {
      document.body.classList.toggle('dark');
    });

    document.getElementById('mapkit-init').addEventListener('click', () => {
      const token = document.getElementById('mapkit-token').value.trim();
      if (!token) {
        mapLog.textContent = 'JWTが入力されていません。Apple Developerで発行したトークンを入力してください。';
        return;
      }

      if (typeof mapkit === 'undefined') {
        mapLog.textContent = 'MapKit JSが読み込まれていません。ネットワーク接続やスクリプトURLを確認してください。';
        return;
      }

      try {
        mapkit.init({
          authorizationCallback: done => {
            done(token);
          }
        });

        state.map = new mapkit.Map('map', {
          colorScheme: document.body.classList.contains('dark') ? mapkit.Map.ColorSchemes.Dark : mapkit.Map.ColorSchemes.Light
        });

        state.map.addEventListener('singleTap', event => {
          const { latitude, longitude } = event.coordinate;
          setQuestLocation(latitude, longitude);
        });

        const lat = parseFloat(latitudeInput.value) || 35.6809591;
        const lon = parseFloat(longitudeInput.value) || 139.7673068;
        const radius = parseFloat(radiusInput.value) || 500;
        focusMap(lat, lon, radius);
        mapLog.textContent = `マップを初期化しました。現在地: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      } catch (error) {
        console.error(error);
        mapLog.textContent = 'MapKitの初期化に失敗しました。ブラウザのコンソールでエラーを確認してください。';
      }
    });

    function focusMap(latitude, longitude, radius) {
      if (!state.map || typeof mapkit === 'undefined') return;
      const coord = new mapkit.Coordinate(latitude, longitude);
      state.map.setRegion(new mapkit.CoordinateRegion(coord, new mapkit.CoordinateSpan(radius / 111000, radius / 111000)));
      setQuestLocation(latitude, longitude);
    }

    function setQuestLocation(latitude, longitude) {
      state.selectedCoordinate = { latitude, longitude };
      latitudeInput.value = latitude.toFixed(6);
      longitudeInput.value = longitude.toFixed(6);

      if (state.marker) {
        if (state.map && typeof mapkit !== 'undefined') {
          state.map.removeAnnotation(state.marker);
        }
        state.marker = null;
      }

      if (state.map && typeof mapkit !== 'undefined') {
        state.marker = new mapkit.MarkerAnnotation(new mapkit.Coordinate(latitude, longitude), {
          title: questFields.title.value || 'クエストポイント',
          subtitle: 'タップで再設定できます',
          color: '#6c4cff'
        });
        state.map.addAnnotation(state.marker);
      }

      renderQuestPreview();
    }

    latitudeInput.addEventListener('change', () => {
      const lat = parseFloat(latitudeInput.value);
      const lon = parseFloat(longitudeInput.value);
      const radius = parseFloat(radiusInput.value) || 500;
      if (Number.isFinite(lat) && Number.isFinite(lon)) {
        focusMap(lat, lon, radius);
        mapLog.textContent = `緯度経度を手動設定: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      }
    });

    longitudeInput.addEventListener('change', () => {
      const lat = parseFloat(latitudeInput.value);
      const lon = parseFloat(longitudeInput.value);
      const radius = parseFloat(radiusInput.value) || 500;
      if (Number.isFinite(lat) && Number.isFinite(lon)) {
        focusMap(lat, lon, radius);
        mapLog.textContent = `緯度経度を手動設定: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      }
    });

    radiusInput.addEventListener('change', () => {
      const radius = parseFloat(radiusInput.value) || 500;
      if (state.selectedCoordinate) {
        focusMap(state.selectedCoordinate.latitude, state.selectedCoordinate.longitude, radius);
        renderQuestPreview();
      }
    });

    Object.values(questFields).forEach(field => {
        field.addEventListener('input', () => {
          if (state.marker && state.map && typeof mapkit !== 'undefined') {
            state.marker.title = questFields.title.value || 'クエストポイント';
          }
          renderQuestPreview();
        });
    });

    document.getElementById('generate-quest').addEventListener('click', async () => {
      const apiKey = document.getElementById('openai-api-key').value.trim();
      if (!apiKey) {
        atlasLog.textContent = 'OpenAI APIキーが入力されていません。Atlasのリクエストを送信できません。';
        return;
      }

      const coordinate = state.selectedCoordinate;
      if (!coordinate) {
        atlasLog.textContent = 'マップでクエスト位置を指定してください。';
        return;
      }

      atlasLog.textContent = 'Atlasにクエスト生成をリクエストしています...';

      const directive = document.getElementById('atlas-directive').value.trim();
      const payload = buildAtlasPayload(coordinate, directive);

      try {
        state.atlasController.abort();
      } catch (_) {
        /* noop */
      }
      state.atlasController = new AbortController();

      try {
        const response = await fetch('https://api.openai.com/v1/responses', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify(payload),
          signal: state.atlasController.signal
        });

        if (!response.ok) {
          const err = await response.text();
          throw new Error(`Atlas APIエラー: ${response.status} ${err}`);
        }

        const data = await response.json();
        const text = extractAtlasText(data);
        atlasLog.textContent = 'Atlasからのレスポンスを受信しました。内容をフォームへ反映します。';
        applyQuestFromAtlas(text);
      } catch (error) {
        if (error.name === 'AbortError') {
          atlasLog.textContent = 'リクエストをキャンセルしました。';
          return;
        }
        console.error(error);
        atlasLog.textContent = `Atlasリクエストに失敗しました: ${error.message}`;
      }
    });

    function buildAtlasPayload(coordinate, directive) {
      const baseInstruction = `You are QuestWeaver, a designer for the 3DAdventure Swift app. Create a JSON quest payload compatible with the iOS uploader. Use the following schema:\n\n` +
        JSON.stringify({
          title: 'string',
          summary: 'string',
          objectives: ['array of strings'],
          difficulty: 'easy|normal|hard|epic',
          rewards: ['array of strings'],
          triggers: ['array of strings'],
          notes: 'string (optional)',
          location: {
            latitude: coordinate.latitude,
            longitude: coordinate.longitude,
            radius: parseFloat(radiusInput.value) || 500
          }
        }, null, 2) +
        '\n\nEnsure the quest references the real-world surroundings of the coordinates. Return ONLY valid JSON.`;

      const messages = [
        {
          role: 'system',
          content: 'You are an expert game quest designer assisting with 3DAdventure quest uploads.'
        },
        {
          role: 'user',
          content: baseInstruction + (directive ? `\n\nAdditional direction: ${directive}` : '')
        }
      ];

      return {
        model: 'atlas-1',
        input: messages,
        max_output_tokens: 900,
        temperature: 0.8
      };
    }

    function extractAtlasText(data) {
      if (data.output && Array.isArray(data.output)) {
        return data.output.map(part => part.content || '').join('\n');
      }
      if (data.choices && Array.isArray(data.choices)) {
        return data.choices.map(choice => choice.message?.content || '').join('\n');
      }
      return data.output_text || JSON.stringify(data, null, 2);
    }

    function applyQuestFromAtlas(text) {
      let parsed;
      try {
        const start = text.indexOf('{');
        const end = text.lastIndexOf('}');
        if (start !== -1 && end !== -1) {
          parsed = JSON.parse(text.slice(start, end + 1));
        }
      } catch (error) {
        console.warn('Atlas JSON parse failed, fallback to raw text', error);
      }

      if (!parsed) {
        atlasLog.textContent += '\nJSONの解析に失敗しました。レスポンスをプレビューに表示します。';
        questPreview.textContent = text;
        return;
      }

      questFields.title.value = parsed.title || '';
      questFields.summary.value = parsed.summary || '';
      questFields.objectives.value = Array.isArray(parsed.objectives) ? parsed.objectives.join('\n') : '';
      questFields.difficulty.value = parsed.difficulty || 'normal';
      questFields.rewards.value = Array.isArray(parsed.rewards) ? parsed.rewards.join('\n') : '';
      questFields.triggers.value = Array.isArray(parsed.triggers) ? parsed.triggers.join('\n') : '';
      questFields.notes.value = parsed.notes || '';

      if (parsed.location) {
        const { latitude, longitude, radius } = parsed.location;
        if (Number.isFinite(latitude) && Number.isFinite(longitude)) {
          latitudeInput.value = latitude;
          longitudeInput.value = longitude;
          setQuestLocation(Number(latitude), Number(longitude));
          if (Number.isFinite(radius)) {
            radiusInput.value = radius;
          }
        }
      }

      renderQuestPreview();
    }

    document.getElementById('upload-quest').addEventListener('click', async () => {
      const quest = collectQuest();
      if (!quest) {
        uploadLog.textContent = '必須項目が不足しています。タイトル、概要、目的、位置を確認してください。';
        return;
      }

      const endpoint = document.getElementById('upload-endpoint').value.trim();
      if (!endpoint) {
        uploadLog.textContent = 'アップロード先エンドポイントを入力してください。';
        return;
      }

      const token = document.getElementById('upload-token').value.trim();

      uploadLog.textContent = 'クエストをアップロードしています...';
      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(token ? { 'Authorization': token } : {})
          },
          body: JSON.stringify(quest)
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(`${response.status} ${text}`);
        }

        uploadLog.textContent = 'アップロードに成功しました。Swiftアプリからも取得できることを確認してください。';
      } catch (error) {
        console.error(error);
        uploadLog.textContent = `アップロードに失敗しました: ${error.message}`;
      }
    });

    document.getElementById('download-quest').addEventListener('click', () => {
      const quest = collectQuest();
      if (!quest) {
        uploadLog.textContent = '必須項目が不足しているため、ダウンロードできません。';
        return;
      }

      const blob = new Blob([JSON.stringify(quest, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const safeTitle = quest.title.replace(/[^a-z0-9_-]+/gi, '_').toLowerCase() || 'quest';
      a.href = url;
      a.download = `${safeTitle}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      uploadLog.textContent = 'JSONファイルをダウンロードしました。Gitやクラウドに保存してチームと共有できます。';
    });

    document.getElementById('reset-all').addEventListener('click', () => {
      Object.values(questFields).forEach(field => field.value = '');
      latitudeInput.value = '';
      longitudeInput.value = '';
      radiusInput.value = 500;
      state.selectedCoordinate = null;
      if (state.map && state.marker && typeof mapkit !== 'undefined') {
        state.map.removeAnnotation(state.marker);
        state.marker = null;
      }
      renderQuestPreview();
      mapLog.textContent = '位置情報がリセットされました。マップで新しい地点を選択してください。';
      atlasLog.textContent = 'Atlasログをリセットしました。';
      uploadLog.textContent = 'アップロードログをリセットしました。';
    });

    document.getElementById('clear-form').addEventListener('click', () => {
      Object.values(questFields).forEach(field => field.value = '');
      renderQuestPreview();
      atlasLog.textContent = 'フォームをクリアしました。位置情報はそのままです。';
    });

    function collectQuest() {
      if (!questFields.title.value.trim() || !questFields.summary.value.trim()) return null;
      if (!questFields.objectives.value.trim()) return null;
      if (!state.selectedCoordinate) return null;

      return {
        title: questFields.title.value.trim(),
        summary: questFields.summary.value.trim(),
        objectives: questFields.objectives.value.split('\n').map(line => line.trim()).filter(Boolean),
        difficulty: questFields.difficulty.value,
        rewards: questFields.rewards.value.split('\n').map(line => line.trim()).filter(Boolean),
        triggers: questFields.triggers.value.split('\n').map(line => line.trim()).filter(Boolean),
        notes: questFields.notes.value.trim() || undefined,
        location: {
          latitude: Number(latitudeInput.value),
          longitude: Number(longitudeInput.value),
          radius: Number(radiusInput.value) || 500
        }
      };
    }

    function renderQuestPreview() {
      const quest = collectQuest();
      if (!quest) {
        questPreview.textContent = JSON.stringify({
          title: questFields.title.value.trim(),
          summary: questFields.summary.value.trim(),
          objectives: questFields.objectives.value.split('\n').map(line => line.trim()).filter(Boolean),
          difficulty: questFields.difficulty.value,
          rewards: questFields.rewards.value.split('\n').map(line => line.trim()).filter(Boolean),
          triggers: questFields.triggers.value.split('\n').map(line => line.trim()).filter(Boolean),
          notes: questFields.notes.value.trim() || undefined,
          location: state.selectedCoordinate ? {
            latitude: Number(latitudeInput.value),
            longitude: Number(longitudeInput.value),
            radius: Number(radiusInput.value) || 500
          } : {
            latitude: null,
            longitude: null,
            radius: Number(radiusInput.value) || 500
          }
        }, null, 2);
        return;
      }

      questPreview.textContent = JSON.stringify(quest, null, 2);
    }

    renderQuestPreview();
  </script>
</body>
</html>
